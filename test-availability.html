<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Availability Check</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Room Availability Check</h1>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Parameters</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Room Type:</label>
                            <select class="form-select" id="testRoomType">
                                <option value="Normal AC Room">Normal AC Room</option>
                                <option value="Normal Non-AC Room">Normal Non-AC Room</option>
                                <option value="Deluxe AC Room">Deluxe AC Room</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Check-in Date:</label>
                            <input type="date" class="form-control" id="testCheckIn" value="2025-10-17">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Check-out Date:</label>
                            <input type="date" class="form-control" id="testCheckOut" value="2025-10-18">
                        </div>
                        <button class="btn btn-primary" onclick="testAvailability()">Test Availability</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        async function testAvailability() {
            const roomType = document.getElementById('testRoomType').value;
            const checkIn = document.getElementById('testCheckIn').value;
            const checkOut = document.getElementById('testCheckOut').value;
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = '<div class="alert alert-info">Testing availability...</div>';
            
            try {
                // Map room type names to database IDs
                const roomTypeMap = {
                    'Normal Non-AC Room': 'normal-non-ac',
                    'Normal AC Room': 'normal-ac',
                    'Deluxe AC Room': 'deluxe-ac'
                };
                
                const roomTypeId = roomTypeMap[roomType] || roomType;
                
                console.log('üîç Testing availability for:', { roomType, roomTypeId, checkIn, checkOut });
                
                if (window.firebaseBookingService && window.firebaseInitialized) {
                    // Get all bookings from database
                    const allBookings = await window.firebaseBookingService.getAllBookings();
                    console.log(`üìä Total bookings in database: ${allBookings.length}`);
                    
                    // Room capacities
                    const roomCapacities = {
                        'normal-non-ac': 3,
                        'normal-ac': 6,
                        'deluxe-ac': 2
                    };
                    
                    const totalCapacity = roomCapacities[roomTypeId] || 1;
                    
                    // Find conflicting bookings
                    const conflictingBookings = allBookings.filter(booking => {
                        const isCorrectRoomType = booking.roomType === roomTypeId;
                        const isConfirmed = booking.status === 'confirmed';
                        const hasDateOverlap = datesOverlap(checkIn, checkOut, booking.arrivalDate, booking.departureDate);
                        
                        console.log(`  üìã Checking booking: ${booking.guestName || 'Unknown'}`);
                        console.log(`    üè® Room type: ${booking.roomType} === ${roomTypeId} ? ${isCorrectRoomType}`);
                        console.log(`    ‚úÖ Status: ${booking.status} === 'confirmed' ? ${isConfirmed}`);
                        console.log(`    üìÖ Dates: ${booking.arrivalDate} to ${booking.departureDate} overlaps ${checkIn} to ${checkOut} ? ${hasDateOverlap}`);
                        console.log(`    üéØ Result: ${isCorrectRoomType && isConfirmed && hasDateOverlap}`);
                        
                        return isCorrectRoomType && isConfirmed && hasDateOverlap;
                    });
                    
                    // Calculate total booked rooms
                    const totalBookedRooms = conflictingBookings.reduce((sum, booking) => {
                        return sum + (booking.roomCount || 1);
                    }, 0);
                    
                    const availableRooms = Math.max(0, totalCapacity - totalBookedRooms);
                    
                    // Display results
                    let html = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Availability Check Complete</h6>
                            <p><strong>Room Type:</strong> ${roomType} (${roomTypeId})</p>
                            <p><strong>Total Capacity:</strong> ${totalCapacity} rooms</p>
                            <p><strong>Conflicting Bookings:</strong> ${conflictingBookings.length}</p>
                            <p><strong>Total Booked Rooms:</strong> ${totalBookedRooms}</p>
                            <p><strong>Available Rooms:</strong> ${availableRooms}</p>
                        </div>
                    `;
                    
                    if (conflictingBookings.length > 0) {
                        html += '<h6>Conflicting Bookings:</h6>';
                        conflictingBookings.forEach((booking, index) => {
                            html += `
                                <div class="alert alert-warning">
                                    <strong>Booking ${index + 1}:</strong><br>
                                    Guest: ${booking.guestName}<br>
                                    Room Type: ${booking.roomType} (${booking.roomTypeText})<br>
                                    Room Count: ${booking.roomCount || 1}<br>
                                    Dates: ${booking.arrivalDate} to ${booking.departureDate}<br>
                                    Status: ${booking.status}<br>
                                    Booking Type: ${booking.bookingType}
                                </div>
                            `;
                        });
                    }
                    
                    resultsDiv.innerHTML = html;
                    
                } else {
                    resultsDiv.innerHTML = '<div class="alert alert-danger">‚ùå Firebase not available</div>';
                }
                
            } catch (error) {
                console.error('Error testing availability:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function datesOverlap(start1, end1, start2, end2) {
            const s1 = new Date(start1);
            const e1 = new Date(end1);
            const s2 = new Date(start2);
            const e2 = new Date(end2);
            
            return s1 < e2 && s2 < e1;
        }
        
        // Test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.firebaseBookingService && window.firebaseInitialized) {
                    console.log('‚úÖ Firebase ready for testing');
                } else {
                    console.log('‚ö†Ô∏è Firebase not ready');
                }
            }, 2000);
        });
    </script>
</body>
</html>

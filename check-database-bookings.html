<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Database Bookings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .booking-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .booking-confirmed {
            border-left: 4px solid #28a745;
        }
        .booking-pending {
            border-left: 4px solid #ffc107;
        }
        .booking-failed {
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Database Bookings Check</h1>
        <div id="status" class="alert alert-info">Loading...</div>
        <div id="bookings-list"></div>
        <button class="btn btn-primary" onclick="checkSpecificDate()">Check October 17-18, 2025</button>
        <div id="specific-check" class="mt-3"></div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-service.js"></script>

    <script>
        let allBookings = [];

        async function loadAllBookings() {
            const statusDiv = document.getElementById('status');
            const bookingsDiv = document.getElementById('bookings-list');
            
            try {
                statusDiv.innerHTML = 'Loading bookings from database...';
                
                if (window.firebaseBookingService && window.firebaseInitialized) {
                    allBookings = await window.firebaseBookingService.getAllBookings();
                    statusDiv.innerHTML = `✅ Loaded ${allBookings.length} bookings from database`;
                    
                    displayBookings(allBookings);
                } else {
                    statusDiv.innerHTML = '❌ Firebase not available';
                }
            } catch (error) {
                statusDiv.innerHTML = `❌ Error: ${error.message}`;
                console.error('Error loading bookings:', error);
            }
        }

        function displayBookings(bookings) {
            const bookingsDiv = document.getElementById('bookings-list');
            
            if (bookings.length === 0) {
                bookingsDiv.innerHTML = '<div class="alert alert-warning">No bookings found in database</div>';
                return;
            }

            let html = '<h3>All Bookings:</h3>';
            
            bookings.forEach((booking, index) => {
                const statusClass = booking.status === 'confirmed' ? 'booking-confirmed' : 
                                  booking.status === 'pending' ? 'booking-pending' : 'booking-failed';
                
                html += `
                    <div class="booking-item ${statusClass}">
                        <h5>Booking ${index + 1}</h5>
                        <p><strong>ID:</strong> ${booking.id || 'N/A'}</p>
                        <p><strong>Booking ID:</strong> ${booking.bookingId || 'N/A'}</p>
                        <p><strong>Guest:</strong> ${booking.guestName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${booking.email || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${booking.phone || 'N/A'}</p>
                        <p><strong>Room Type:</strong> ${booking.roomType || 'N/A'}</p>
                        <p><strong>Room Type Text:</strong> ${booking.roomTypeText || 'N/A'}</p>
                        <p><strong>Room Count:</strong> ${booking.roomCount || 1}</p>
                        <p><strong>Check-in:</strong> ${booking.arrivalDate || 'N/A'}</p>
                        <p><strong>Check-out:</strong> ${booking.departureDate || 'N/A'}</p>
                        <p><strong>Status:</strong> ${booking.status || 'N/A'}</p>
                        <p><strong>Booking Type:</strong> ${booking.bookingType || 'N/A'}</p>
                        <p><strong>Total:</strong> ₹${booking.total || 'N/A'}</p>
                        <p><strong>Created:</strong> ${booking.createdAt ? new Date(booking.createdAt).toLocaleString() : 'N/A'}</p>
                    </div>
                `;
            });
            
            bookingsDiv.innerHTML = html;
        }

        function checkSpecificDate() {
            const checkDiv = document.getElementById('specific-check');
            const targetDate = '2025-10-17';
            const targetDateEnd = '2025-10-18';
            
            // Find bookings for October 17-18, 2025
            const conflictingBookings = allBookings.filter(booking => {
                if (booking.status !== 'confirmed') return false;
                
                const bookingStart = booking.arrivalDate;
                const bookingEnd = booking.departureDate;
                
                // Check if dates overlap
                const hasOverlap = datesOverlap(targetDate, targetDateEnd, bookingStart, bookingEnd);
                return hasOverlap;
            });
            
            let html = `<h4>Bookings for October 17-18, 2025:</h4>`;
            
            if (conflictingBookings.length === 0) {
                html += '<div class="alert alert-success">No confirmed bookings found for these dates</div>';
            } else {
                html += `<div class="alert alert-warning">Found ${conflictingBookings.length} conflicting bookings:</div>`;
                
                conflictingBookings.forEach((booking, index) => {
                    html += `
                        <div class="booking-item booking-confirmed">
                            <h6>Conflicting Booking ${index + 1}</h6>
                            <p><strong>Guest:</strong> ${booking.guestName}</p>
                            <p><strong>Room Type:</strong> ${booking.roomType} (${booking.roomTypeText})</p>
                            <p><strong>Room Count:</strong> ${booking.roomCount}</p>
                            <p><strong>Check-in:</strong> ${booking.arrivalDate}</p>
                            <p><strong>Check-out:</strong> ${booking.departureDate}</p>
                            <p><strong>Booking Type:</strong> ${booking.bookingType}</p>
                        </div>
                    `;
                });
                
                // Calculate room availability
                const roomCapacities = {
                    'normal-non-ac': 3,
                    'normal-ac': 6,
                    'deluxe-ac': 2
                };
                
                html += '<h5>Room Availability Summary:</h5>';
                
                Object.keys(roomCapacities).forEach(roomType => {
                    const capacity = roomCapacities[roomType];
                    const bookedRooms = conflictingBookings
                        .filter(b => b.roomType === roomType)
                        .reduce((sum, b) => sum + (b.roomCount || 1), 0);
                    const available = Math.max(0, capacity - bookedRooms);
                    
                    html += `
                        <div class="alert ${available > 0 ? 'alert-success' : 'alert-danger'}">
                            <strong>${roomType}:</strong> ${available}/${capacity} rooms available (${bookedRooms} booked)
                        </div>
                    `;
                });
            }
            
            checkDiv.innerHTML = html;
        }

        function datesOverlap(start1, end1, start2, end2) {
            const s1 = new Date(start1);
            const e1 = new Date(end1);
            const s2 = new Date(start2);
            const e2 = new Date(end2);
            
            return s1 < e2 && s2 < e1;
        }

        // Load bookings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadAllBookings, 1000);
        });
    </script>
</body>
</html>
